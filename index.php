<?php

include_once 'library/CacheLite/Cache/Lite.php';

define('FEED_URL', 'http://www.cvedetails.com/json-feed.php?numrows=30&vendor_id=0&product_id=0&version_id=0&hasexp=1&opec=1&opov=1&opcsrf=1&opfileinc=1&opgpriv=1&opsqli=1&opxss=1&opdirt=1&opmemc=1&ophttprs=1&opbyp=1&opginf=1&opdos=1&orderby=2&cvssscoremin=0');
$keywords = array('drupal', 'wordpress', 'apache', 'php', 'mysql', 'mariadb');

// Parameters
$format = $_GET['format'];
$lifetime = $_GET['lifetime'];  // in hours
if( $lifetime < 0 && $lifetime > 12 ) {
  $lifetime = 3600 * 3;  // Default 3 hours
} else {
  $lifetime = 3600 * $lifetime;
}
$cacheId = $format . $lifetime;

$cacheOptions = array(
  'cacheDir' => realpath(dirname(__FILE__)) . '/cache/',
  'lifeTime' => $lifetime
);

header('Content-Type: application/json; charset=utf-8');

$Cache_Lite = new Cache_Lite($cacheOptions);

if ($data = $Cache_Lite->get($cacheId) ) {
  header('X-CacheHit: true');

  if( $format === "json" ) {
    print json_encode(unserialize($data), JSON_PRETTY_PRINT);
  } else if( $format === "rss" ) {
    print formatJsonAsRSS(unserialize($data));
  }

} else {
  header('X-CacheHit: false');
  $content = file_get_contents(FEED_URL);
  $json = json_decode($content, true);

  $countItem = 0;

  $finalArray = array();

  foreach($json as $item) {

    $summary = $item['summary'];
    $atLeastOneKeywordFound = FALSE;

    // Find keywords in summary
    foreach($keywords as $keyword) {
      if( preg_match('/' . $keyword . '/i', $summary) ) {
        $atLeastOneKeywordFound = TRUE;
        $item['keyword'] = $keyword;
        break;
      }
    }

    if( $atLeastOneKeywordFound ) {
      $finalArray[] = $item;
    }

  }

  $Cache_Lite->save(serialize($finalArray), $cacheId);
  if( $format === "json" ) {
    print json_encode($finalArray, JSON_PRETTY_PRINT);
  } else if( $format === "rss" ) {
    print formatJsonAsRSS($finalArray);
  }

}


function formatJsonAsRSS($json) {
  $feedName = "Security Feed";
  $feedUrl = "http://$_SERVER[HTTP_HOST]$_SERVER[REQUEST_URI]";
  $feedUrlNoPram = "http://$_SERVER[HTTP_HOST]";
  $lastBuildDate = date('r');
  $feedDescription = "Security feed watching CVE reports of a list of keywords.";

  $rssHeader = '<?xml version="1.0" encoding="UTF-8"?>
<rss xmlns:content="http://purl.org/rss/1.0/modules/content/" xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:media="http://search.yahoo.com/mrss/" xmlns:slash="http://purl.org/rss/1.0/modules/slash/" xmlns:sy="http://purl.org/rss/1.0/modules/syndication/" xmlns:wfw="http://wellformedweb.org/CommentAPI/" version="2.0">
  <channel>
    <title>Security Feed</title>
    <link>'. $feedUrlNoPram .'</link>
    <description>'. $feedDescription .'</description>
    <lastBuildDate>'. $lastBuildDate .'</lastBuildDate>
    <language>en-US</language>
    <sy:updatePeriod>hourly</sy:updatePeriod>
    <sy:updateFrequency>1</sy:updateFrequency>';
  $rssFooter = '  </channel>
</rss>';

  $rssItems = '';
  foreach($json as $item) {
    $rssItems .= '    <item>
      <title>' . $item['cve_id'] . ' [' . $item['keyword'] . ']</title>
      <link>' . $item['url'] . '</link>
      <pubDate>' . DateTime::createFromFormat('Y-m-d', $item['update_date'])->format('r') . '</pubDate>
      <dc:creator><![CDATA[Alexandre Vallières-Lagacé]]></dc:creator>
      <category><![CDATA[' . $item['keyword'] . ']]></category>
      <guid isPermaLink="false">' . $item['url'] . '</guid>
      <description><![CDATA[' . $item['summary'] . ']]></description>
      <slash:comments>0</slash:comments>
    </item>' . "\n";
  }

  return $rssHeader . $rssItems . $rssFooter;
}

